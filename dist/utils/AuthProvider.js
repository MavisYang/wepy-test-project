'use strict';

var wxRequest = require('./wxRequest.js');
var API = require('./api.js');

function onLogin(type, phoneNum, callback) {
    if (phoneNum) {
        //有手机号码就是第一次进来你，然后保存下来
        wx.setStorageSync('phoneNum', phoneNum);
    }
    var url = void 0,
        dataParams = void 0,
        tokenParams = void 0;
    if (type === 'sell') {
        url = API.getToken;
        tokenParams = null;
        dataParams = {
            phone: phoneNum || wx.getStorageSync('phoneNum'),
            id: wx.getStorageSync('unionid')
        };
    } else if (type === 'buy') {
        tokenParams = { type: 'Basic', value: API.SECRET };
        url = API.getTokenC + 'unionid_' + wx.getStorageSync('unionid') + '_type_2';
    }
    return wxRequest.fetch(url, tokenParams, dataParams, "POST").then(function (res) {
        if (res.data.resultCode === '100') {
            console.log('卖家鉴权');
            saveTokens(res.data.resultContent.access_token, res.data.resultContent.refresh_token, res.data.resultContent.expires_in);
            callback(res.data);
            return res.data.resultContent.access_token;
        } else if (res.data.resultCode === '02504046') {
            callback({ msg: '该用户不在白名单内', code: 404 });
        } else if (res.data.access_token) {
            console.log('买家鉴权');
            saveTokens(res.data.access_token, res.data.refresh_token, res.data.expires_in);
            return res.data.access_token;
        } else {
            callback({ msg: '异常错误', code: 304 });
        }
    }).catch(function (req) {
        callback({ msg: '请求出错', code: 502 });
        return 'error';
    });
}
function setWait() {
    wx.removeStorageSync('access_token');
}
function saveTokens(access_token, refresh_token, expires_in) {
    wx.setStorageSync('access_token', access_token);
    wx.setStorageSync('refresh_token', refresh_token);
    var exp = new Date();
    var expires_ins = exp.getTime() + expires_in * 1000 - 30000;
    wx.setStorageSync('expires_in', expires_ins);
}
function onRefreshToken() {
    setWait();
    var token = API.SECRET;
    var url = API.refreshToken + wx.getStorageSync('refresh_token');
    return wxRequest.fetch(url, { type: 'Basic', value: token }, '', 'POST').then(function (res) {
        if (res.data.access_token) {
            saveTokens(res.data.access_token, res.data.refresh_token, res.data.expires_in);
            return res.data.access_token;
        } else {
            return onLogin(wx.getStorageSync('userType'), null, function (res) {}).then(function (res) {
                return res;
            });
        }
    }).catch(function (req) {
        if (wx.getStorageSync('refresh_token') != null) {
            return onLogin(wx.getStorageSync('userType'), null, function (res) {}).then(function (res) {
                return res;
            });
        }
    });
}
function getAccessToken() {
    var date = new Date();
    var dt = date.getTime();
    var expires_in = wx.getStorageSync('expires_in');
    if (!wx.getStorageSync('access_token') || !wx.getStorageSync('expires_in') || !wx.getStorageSync('refresh_token')) {
        return onLogin(wx.getStorageSync('userType'), wx.getStorageSync('phoneNum'), function (res) {
            "use strict";

            console.log(res);
        });
    } else {
        console.log("222");
        if ((!expires_in || dt >= expires_in) && wx.getStorageSync('access_token')) {
            console.log("333");
            return onRefreshToken();
        } else if (!wx.getStorageSync('access_token')) {
            console.log("444");
            return new Promise(function (resolve, reject) {
                setTimeout(function () {
                    resolve(wx.getStorageSync('access_token'));
                }, 2000);
            });
        } else {
            console.log("555");
            return new Promise(function (resolve, reject) {
                resolve(wx.getStorageSync('access_token'));
            });
        }
    }
}
module.exports = {
    onLogin: onLogin,
    getAccessToken: getAccessToken
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkF1dGhQcm92aWRlci5qcyJdLCJuYW1lcyI6WyJ3eFJlcXVlc3QiLCJyZXF1aXJlIiwiQVBJIiwib25Mb2dpbiIsInR5cGUiLCJwaG9uZU51bSIsImNhbGxiYWNrIiwid3giLCJzZXRTdG9yYWdlU3luYyIsInVybCIsImRhdGFQYXJhbXMiLCJ0b2tlblBhcmFtcyIsImdldFRva2VuIiwicGhvbmUiLCJnZXRTdG9yYWdlU3luYyIsImlkIiwidmFsdWUiLCJTRUNSRVQiLCJnZXRUb2tlbkMiLCJmZXRjaCIsInRoZW4iLCJyZXMiLCJkYXRhIiwicmVzdWx0Q29kZSIsImNvbnNvbGUiLCJsb2ciLCJzYXZlVG9rZW5zIiwicmVzdWx0Q29udGVudCIsImFjY2Vzc190b2tlbiIsInJlZnJlc2hfdG9rZW4iLCJleHBpcmVzX2luIiwibXNnIiwiY29kZSIsImNhdGNoIiwicmVxIiwic2V0V2FpdCIsInJlbW92ZVN0b3JhZ2VTeW5jIiwiZXhwIiwiRGF0ZSIsImV4cGlyZXNfaW5zIiwiZ2V0VGltZSIsIm9uUmVmcmVzaFRva2VuIiwidG9rZW4iLCJyZWZyZXNoVG9rZW4iLCJnZXRBY2Nlc3NUb2tlbiIsImRhdGUiLCJkdCIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0Iiwic2V0VGltZW91dCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBTUEsWUFBWUMsUUFBUSxhQUFSLENBQWxCO0FBQ0EsSUFBTUMsTUFBTUQsUUFBUSxPQUFSLENBQVo7O0FBRUEsU0FBU0UsT0FBVCxDQUFpQkMsSUFBakIsRUFBdUJDLFFBQXZCLEVBQWlDQyxRQUFqQyxFQUEyQztBQUN2QyxRQUFJRCxRQUFKLEVBQWM7QUFDVjtBQUNBRSxXQUFHQyxjQUFILENBQWtCLFVBQWxCLEVBQThCSCxRQUE5QjtBQUNIO0FBQ0QsUUFBSUksWUFBSjtBQUFBLFFBQVNDLG1CQUFUO0FBQUEsUUFBcUJDLG9CQUFyQjtBQUNBLFFBQUlQLFNBQVMsTUFBYixFQUFxQjtBQUNqQkss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RSxFQUFpSDtBQUM3RyxlQUFPWCxRQUFRSSxHQUFHTyxjQUFILENBQWtCLFVBQWxCLENBQVIsRUFBdUNQLEdBQUdPLGNBQUgsQ0FBa0IsVUFBbEIsQ0FBdkMsRUFBcUUsZUFBSztBQUM3RTs7QUFDQVUsb0JBQVFDLEdBQVIsQ0FBWUosR0FBWjtBQUNILFNBSE0sQ0FBUDtBQUlILEtBTEQsTUFLTTtBQUNGRyxnQkFBUUMsR0FBUixDQUFZLEtBQVo7QUFDQSxZQUFJLENBQUMsQ0FBQ0ssVUFBRCxJQUFlZ0IsTUFBTWhCLFVBQXRCLEtBQXFDdkIsR0FBR08sY0FBSCxDQUFrQixjQUFsQixDQUF6QyxFQUE0RTtBQUN4RVUsb0JBQVFDLEdBQVIsQ0FBWSxLQUFaO0FBQ0EsbUJBQU9nQixnQkFBUDtBQUNILFNBSEQsTUFHTyxJQUFJLENBQUNsQyxHQUFHTyxjQUFILENBQWtCLGNBQWxCLENBQUwsRUFBd0M7QUFDM0NVLG9CQUFRQyxHQUFSLENBQVksS0FBWjtBQUNBLG1CQUFPLElBQUlzQixPQUFKLENBQVksVUFBQ0MsT0FBRCxFQUFVQyxNQUFWLEVBQXFCO0FBQ3BDQywyQkFBVyxZQUFNO0FBQ2JGLDRCQUFRekMsR0FBR08sY0FBSCxDQUFrQixjQUFsQixDQUFSO0FBQ0gsaUJBRkQsRUFFRyxJQUZIO0FBR0gsYUFKTSxDQUFQO0FBS0gsU0FQTSxNQU9BO0FBQ0hVLG9CQUFRQyxHQUFSLENBQVksS0FBWjtBQUNBLG1CQUFPLElBQUlzQixPQUFKLENBQVksVUFBQ0MsT0FBRCxFQUFVQyxNQUFWLEVBQXFCO0FBQ3BDRCx3QkFBUXpDLEdBQUdPLGNBQUgsQ0FBa0IsY0FBbEIsQ0FBUjtBQUNILGFBRk0sQ0FBUDtBQUdIO0FBQ0o7QUFDSjtBQUNEcUMsT0FBT0MsT0FBUCxHQUFpQjtBQUNiakQsYUFBU0EsT0FESTtBQUVieUMsb0JBQWdCQTtBQUZILENBQWpCIiwiZmlsZSI6IkF1dGhQcm92aWRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHd4UmVxdWVzdCA9IHJlcXVpcmUoJy4vd3hSZXF1ZXN0Jyk7XG5jb25zdCBBUEkgPSByZXF1aXJlKCcuL2FwaScpO1xuXG5mdW5jdGlvbiBvbkxvZ2luKHR5cGUsIHBob25lTnVtLCBjYWxsYmFjaykge1xuICAgIGlmIChwaG9uZU51bSkge1xuICAgICAgICAvL+acieaJi+acuuWPt+eggeWwseaYr+esrOS4gOasoei/m+adpeS9oO+8jOeEtuWQjuS/neWtmOS4i+adpVxuICAgICAgICB3eC5zZXRTdG9yYWdlU3luYygncGhvbmVOdW0nLCBwaG9uZU51bSlcbiAgICB9XG4gICAgbGV0IHVybCwgZGF0YVBhcmFtcywgdG9rZW5QYXJhbXM7XG4gICAgaWYgKHR5cGUgPT09ICdzZWxsJykge1xuICAgICAgICB1cmwgPSBBUEkuZ2V0VG9rZW47XG4gICAgICAgIHRva2VuUGFyYW1zID0gbnVsbDtcbiAgICAgICAgZGF0YVBhcmFtcyA9IHtcbiAgICAgICAgICAgIHBob25lOiBwaG9uZU51bSB8fCB3eC5nZXRTdG9yYWdlU3luYygncGhvbmVOdW0nKSxcbiAgICAgICAgICAgIGlkOiB3eC5nZXRTdG9yYWdlU3luYygndW5pb25pZCcpXG4gICAgICAgIH1cbiAgICB9IGVsc2UgaWYgKCh0eXBlID09PSAnYnV5JykpIHtcbiAgICAgICAgdG9rZW5QYXJhbXMgPSB7IHR5cGU6ICdCYXNpYycsIHZhbHVlOiBBUEkuU0VDUkVUIH07XG4gICAgICAgIHVybCA9IEFQSS5nZXRUb2tlbkMgKyAndW5pb25pZF8nICsgd3guZ2V0U3RvcmFnZVN5bmMoJ3VuaW9uaWQnKSArICdfdHlwZV8yJztcbiAgICB9XG4gICAgcmV0dXJuIHd4UmVxdWVzdC5mZXRjaCh1cmwsIHRva2VuUGFyYW1zLCBkYXRhUGFyYW1zLCBcIlBPU1RcIikudGhlbigocmVzKSA9PiB7XG4gICAgICAgIGlmIChyZXMuZGF0YS5yZXN1bHRDb2RlID09PSAnMTAwJykge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ+WNluWutumJtOadgycpO1xuICAgICAgICAgICAgc2F2ZVRva2VucyhyZXMuZGF0YS5yZXN1bHRDb250ZW50LmFjY2Vzc190b2tlbiwgcmVzLmRhdGEucmVzdWx0Q29udGVudC5yZWZyZXNoX3Rva2VuLCByZXMuZGF0YS5yZXN1bHRDb250ZW50LmV4cGlyZXNfaW4pO1xuICAgICAgICAgICAgY2FsbGJhY2socmVzLmRhdGEpO1xuICAgICAgICAgICAgcmV0dXJuIHJlcy5kYXRhLnJlc3VsdENvbnRlbnQuYWNjZXNzX3Rva2VuXG4gICAgICAgIH0gZWxzZSBpZiAocmVzLmRhdGEucmVzdWx0Q29kZSA9PT0gJzAyNTA0MDQ2Jykge1xuICAgICAgICAgICAgY2FsbGJhY2soeyBtc2c6ICfor6XnlKjmiLfkuI3lnKjnmb3lkI3ljZXlhoUnLCBjb2RlOiA0MDQgfSlcbiAgICAgICAgfSBlbHNlIGlmIChyZXMuZGF0YS5hY2Nlc3NfdG9rZW4pIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCfkubDlrrbpibTmnYMnKTtcbiAgICAgICAgICAgIHNhdmVUb2tlbnMocmVzLmRhdGEuYWNjZXNzX3Rva2VuLCByZXMuZGF0YS5yZWZyZXNoX3Rva2VuLCByZXMuZGF0YS5leHBpcmVzX2luKTtcbiAgICAgICAgICAgIHJldHVybiByZXMuZGF0YS5hY2Nlc3NfdG9rZW5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNhbGxiYWNrKHsgbXNnOiAn5byC5bi46ZSZ6K+vJywgY29kZTogMzA0IH0pXG4gICAgICAgIH1cbiAgICB9KS5jYXRjaCgocmVxKSA9PiB7XG4gICAgICAgIGNhbGxiYWNrKHsgbXNnOiAn6K+35rGC5Ye66ZSZJywgY29kZTogNTAyIH0pO1xuICAgICAgICByZXR1cm4gJ2Vycm9yJ1xuICAgIH0pXG59XG5mdW5jdGlvbiBzZXRXYWl0KCkge1xuICAgIHd4LnJlbW92ZVN0b3JhZ2VTeW5jKCdhY2Nlc3NfdG9rZW4nKTtcbn1cbmZ1bmN0aW9uIHNhdmVUb2tlbnMoYWNjZXNzX3Rva2VuLCByZWZyZXNoX3Rva2VuLCBleHBpcmVzX2luKSB7XG4gICAgd3guc2V0U3RvcmFnZVN5bmMoJ2FjY2Vzc190b2tlbicsIGFjY2Vzc190b2tlbik7XG4gICAgd3guc2V0U3RvcmFnZVN5bmMoJ3JlZnJlc2hfdG9rZW4nLCByZWZyZXNoX3Rva2VuKTtcbiAgICB2YXIgZXhwID0gbmV3IERhdGUoKTtcbiAgICB2YXIgZXhwaXJlc19pbnMgPSBleHAuZ2V0VGltZSgpICsgZXhwaXJlc19pbiAqIDEwMDAgLSAzMDAwMDtcbiAgICB3eC5zZXRTdG9yYWdlU3luYygnZXhwaXJlc19pbicsIGV4cGlyZXNfaW5zKTtcbn1cbmZ1bmN0aW9uIG9uUmVmcmVzaFRva2VuKCkge1xuICAgIHNldFdhaXQoKTtcbiAgICBsZXQgdG9rZW4gPSBBUEkuU0VDUkVUO1xuICAgIHZhciB1cmwgPSBBUEkucmVmcmVzaFRva2VuICsgd3guZ2V0U3RvcmFnZVN5bmMoJ3JlZnJlc2hfdG9rZW4nKTtcbiAgICByZXR1cm4gd3hSZXF1ZXN0LmZldGNoKHVybCwgeyB0eXBlOiAnQmFzaWMnLCB2YWx1ZTogdG9rZW4gfSwgJycsICdQT1NUJykudGhlbigocmVzKSA9PiB7XG4gICAgICAgIGlmIChyZXMuZGF0YS5hY2Nlc3NfdG9rZW4pIHtcbiAgICAgICAgICAgIHNhdmVUb2tlbnMocmVzLmRhdGEuYWNjZXNzX3Rva2VuLCByZXMuZGF0YS5yZWZyZXNoX3Rva2VuLCByZXMuZGF0YS5leHBpcmVzX2luKTtcbiAgICAgICAgICAgIHJldHVybiByZXMuZGF0YS5hY2Nlc3NfdG9rZW47XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gb25Mb2dpbih3eC5nZXRTdG9yYWdlU3luYygndXNlclR5cGUnKSwgbnVsbCwgcmVzID0+IHsgfSkudGhlbihyZXMgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfSkuY2F0Y2gocmVxID0+IHtcbiAgICAgICAgaWYgKHd4LmdldFN0b3JhZ2VTeW5jKCdyZWZyZXNoX3Rva2VuJykgIT0gbnVsbCkge1xuICAgICAgICAgICAgcmV0dXJuIG9uTG9naW4od3guZ2V0U3RvcmFnZVN5bmMoJ3VzZXJUeXBlJyksIG51bGwsIHJlcyA9PiB7IH0pLnRoZW4ocmVzID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH0pXG59XG5mdW5jdGlvbiBnZXRBY2Nlc3NUb2tlbigpIHtcbiAgICB2YXIgZGF0ZSA9IG5ldyBEYXRlKCk7XG4gICAgdmFyIGR0ID0gZGF0ZS5nZXRUaW1lKCk7XG4gICAgdmFyIGV4cGlyZXNfaW4gPSB3eC5nZXRTdG9yYWdlU3luYygnZXhwaXJlc19pbicpO1xuICAgIGlmKCF3eC5nZXRTdG9yYWdlU3luYygnYWNjZXNzX3Rva2VuJykgfHwgIXd4LmdldFN0b3JhZ2VTeW5jKCdleHBpcmVzX2luJykgfHwgIXd4LmdldFN0b3JhZ2VTeW5jKCdyZWZyZXNoX3Rva2VuJykpe1xuICAgICAgICByZXR1cm4gb25Mb2dpbih3eC5nZXRTdG9yYWdlU3luYygndXNlclR5cGUnKSwgd3guZ2V0U3RvcmFnZVN5bmMoJ3Bob25lTnVtJykscmVzPT57XG4gICAgICAgICAgICBcInVzZSBzdHJpY3RcIjtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlcyk7XG4gICAgICAgIH0pXG4gICAgfWVsc2Uge1xuICAgICAgICBjb25zb2xlLmxvZyhcIjIyMlwiKVxuICAgICAgICBpZiAoKCFleHBpcmVzX2luIHx8IGR0ID49IGV4cGlyZXNfaW4pICYmIHd4LmdldFN0b3JhZ2VTeW5jKCdhY2Nlc3NfdG9rZW4nKSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCIzMzNcIilcbiAgICAgICAgICAgIHJldHVybiBvblJlZnJlc2hUb2tlbigpO1xuICAgICAgICB9IGVsc2UgaWYgKCF3eC5nZXRTdG9yYWdlU3luYygnYWNjZXNzX3Rva2VuJykpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiNDQ0XCIpXG4gICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHd4LmdldFN0b3JhZ2VTeW5jKCdhY2Nlc3NfdG9rZW4nKSlcbiAgICAgICAgICAgICAgICB9LCAyMDAwKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiNTU1XCIpXG4gICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgICAgIHJlc29sdmUod3guZ2V0U3RvcmFnZVN5bmMoJ2FjY2Vzc190b2tlbicpKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgIH1cbn1cbm1vZHVsZS5leHBvcnRzID0ge1xuICAgIG9uTG9naW46IG9uTG9naW4sXG4gICAgZ2V0QWNjZXNzVG9rZW46IGdldEFjY2Vzc1Rva2VuXG59Il19